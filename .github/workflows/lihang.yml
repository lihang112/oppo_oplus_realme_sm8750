name: 生产级构建-一加13内核-自定义驱动版

env:
  TZ: Asia/Shanghai
  ANDROID_VERSION: 'android15'
  KERNEL_VERSION: '6.6'
  KERNEL_NAME: 'android15-8-g29d86c5fc9dd-abogki428889875-4k'

on:
  workflow_dispatch:
    inputs:
      ksu_type:
        description: 'KernelSU分支'
        required: true
        type: choice
        default: 'sukisu'
        options: [ 'sukisu', 'resukisu', 'ksunext', 'mksu', 'ksu', 'none' ]
      susfs_enable:
        description: '是否开启susfs'
        required: true
        type: boolean
        default: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 环境初始化
        run: |
          rm -rf kernel_workspace && mkdir kernel_workspace && cd kernel_workspace
          sudo apt update && sudo apt-get install -y --no-install-recommends binutils python-is-python3 libssl-dev libelf-dev ccache aria2 zip unzip
          
          echo "克隆源码中..."
          aria2c -s16 -x16 -k1M https://github.com/cctv18/android_kernel_common_oneplus_sm8750/archive/refs/heads/oneplus/sm8750_v_16.0.0_oneplus_13_6.6.89.zip -o common.zip
          unzip -q common.zip && mv "android_kernel_common_oneplus_sm8750-oneplus-sm8750_v_16.0.0_oneplus_13_6.6.89" common && rm common.zip
          
          echo "获取工具链..."
          mkdir -p clang18 && aria2c -s16 -x16 -k1M https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang18-r510928/clang-r510928.zip -o clang.zip
          unzip -q clang.zip -d clang18 && rm clang.zip

      # ======= 这里是注入驱动的关键位置 =======
      - name: 注入自定义通信驱动 /dev/my_comm
        run: |
          cd kernel_workspace/common
          cat <<EOF > drivers/char/my_comm.c
          #include <linux/module.h>
          #include <linux/fs.h>
          #include <linux/uaccess.h>
          #include <linux/miscdevice.h>
          static ssize_t my_comm_read(struct file *file, char __user *buf, size_t count, loff_t *ppos) {
              char msg[] = "Success from my_comm!\n";
              return simple_read_from_buffer(buf, count, ppos, msg, sizeof(msg));
          }
          static const struct file_operations my_comm_fops = { .owner = THIS_MODULE, .read = my_comm_read };
          static struct miscdevice my_comm_misc = { .minor = MISC_DYNAMIC_MINOR, .name = "my_comm", .fops = &my_comm_fops, .mode = 0666 };
          static int __init my_comm_init(void) { return misc_register(&my_comm_misc); }
          static void __exit my_comm_exit(void) { misc_deregister(&my_comm_misc); }
          module_init(my_comm_init); module_exit(my_comm_exit);
          MODULE_LICENSE("GPL");
          EOF
          sed -i '1i\obj-y += my_comm.o' drivers/char/Makefile

      - name: 载入 ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache_6.6.89
          key: ccache-kernel-6.6.89-${{ github.sha }}
          restore-keys: ccache-kernel-6.6.89-

      - name: 执行内核编译
        run: |
          cd kernel_workspace/common
          export PATH=$GITHUB_WORKSPACE/kernel_workspace/clang18/bin:$PATH
          export USE_CCACHE=1
          export CCACHE_DIR=~/.ccache_6.6.89
          make LLVM=1 ARCH=arm64 gki_defconfig
          make -j$(nproc --all) LLVM=1 ARCH=arm64 CLANG_TRIPLE=aarch64-linux-gnu- CROSS_COMPILE=aarch64-linux-gnu- Image

      - name: 高级打包 (基于 AnyKernel3 并适配一加13)
        if: success()
        run: |
          git clone https://github.com/osm0sis/AnyKernel3.git
          cp kernel_workspace/common/arch/arm64/boot/Image AnyKernel3/
          cd AnyKernel3
          # 关键适配修改
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' anykernel.sh
          sed -i 's|BLOCK=/dev/block/platform/omap/omap_hsmmc.0/by-name/boot;|BLOCK=auto;|g' anykernel.sh
          zip -r9 ../Oneplus13-Kernel-Flashable.zip *

      - name: 上传产物
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Oneplus13-Final-Kernel
          path: Oneplus13-Kernel-Flashable.zip
