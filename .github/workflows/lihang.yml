name: 加速版构建 6.6.89 欧加真OKI内核

env:
  TZ: Asia/Shanghai
  ANDROID_VERSION: 'android15'
  KERNEL_VERSION: '6.6'
  KERNEL_NAME: 'android15-8-g29d86c5fc9dd-abogki428889875-4k'

on:
  workflow_dispatch:
    inputs:
      ksu_type:
        description: 'KernelSU分支'
        required: true
        type: choice
        default: 'sukisu'
        options: [ 'sukisu', 'resukisu', 'ksunext', 'mksu', 'ksu', 'none' ]
      susfs_enable:
        description: '是否开启susfs'
        required: true
        type: boolean
        default: 'true'
      # ... 其他输入参数保持不变 ...
      adios_enable:
        description: '是否启用ADIOS IO调度器支持'
        required: true
        type: boolean
        default: 'true'
      baseband_guard:
        description: '是否开启内核级基带保护'
        required: true
        type: boolean
        default: 'true'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 安装环境依赖+初始化源码仓库及llvm-Clang18工具链
        run: |
          rm -rf kernel_workspace && mkdir kernel_workspace && cd kernel_workspace
          sudo apt update && sudo apt-get install -y --no-install-recommends binutils python-is-python3 libssl-dev libelf-dev ccache
          
          echo "正在克隆源码仓库..."
          aria2c -s16 -x16 -k1M https://github.com/cctv18/android_kernel_common_oneplus_sm8750/archive/refs/heads/oneplus/sm8750_v_16.0.0_oneplus_13_6.6.89.zip -o common.zip
          unzip -q common.zip && mv "android_kernel_common_oneplus_sm8750-oneplus-sm8750_v_16.0.0_oneplus_13_6.6.89" common
          
          echo "正在克隆工具链..."
          mkdir -p clang18 && aria2c -s16 -x16 -k1M https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang18-r510928/clang-r510928.zip -o clang.zip
          unzip -q clang.zip -d clang18
          
          echo "正在克隆构建工具..."
          aria2c -s16 -x16 -k1M https://github.com/cctv18/oneplus_sm8650_toolchain/releases/download/LLVM-Clang18-r510928/build-tools.zip -o build-tools.zip
          unzip -q build-tools.zip && wait

      - name: 注入自定义通信驱动 /dev/my_comm
        run: |
          cd kernel_workspace/common
          
          # 1. 写入驱动源码
          cat <<EOF > drivers/char/my_comm.c
          #include <linux/module.h>
          #include <linux/fs.h>
          #include <linux/uaccess.h>
          #include <linux/miscdevice.h>

          static ssize_t my_comm_read(struct file *file, char __user *buf, size_t count, loff_t *ppos) {
              char msg[] = "Success from my_comm!\n";
              return simple_read_from_buffer(buf, count, ppos, msg, sizeof(msg));
          }

          static const struct file_operations my_comm_fops = {
              .owner = THIS_MODULE,
              .read = my_comm_read,
          };

          static struct miscdevice my_comm_misc = {
              .minor = MISC_DYNAMIC_MINOR,
              .name = "my_comm",
              .fops = &my_comm_fops,
              .mode = 0666, 
          };

          static int __init my_comm_init(void) { return misc_register(&my_comm_misc); }
          static void __exit my_comm_exit(void) { misc_deregister(&my_comm_misc); }

          module_init(my_comm_init);
          module_exit(my_comm_exit);
          MODULE_LICENSE("GPL");
          EOF

          # 2. 注册到 Makefile
          echo "obj-y += my_comm.o" >> drivers/char/Makefile

      - name: 配置并载入 ccache 缓存
        uses: actions/cache@v4
        with:
          path: ~/.ccache_6.6.89
          key: ccache-neov4-6.6.89-${{ runner.os }}-main

      - name: 执行内核编译
        run: |
          cd kernel_workspace/common
          # 这里应包含具体的编译指令，例如使用 Clang 编译 Image
          # 示例：make LLVM=1 ARCH=arm64 gki_defconfig && make LLVM=1 ARCH=arm64 -j$(nproc)
